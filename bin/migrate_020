#!/usr/bin/env ruby

require 'yaml'

if ARGV.length < 2
  puts "Migrates fdoc v 0.1.* files to 0.2.0"
  abort "Usage: doc_to_html [from_dir] [to_dir]"
end

class String
  def chomp_slash
    sub(/(\/)+$/, '')
  end
end

from_dir, to_dir = ARGV[0..2]

base_path = ""
Dir[File.join(from_dir, "**/*.fdoc")].each do |fdoc_path|
  resource = YAML.load_file(fdoc_path)
  base_path = resource["basePath"]

  resource["actions"].each do |action|
    action_path = File.join(base_path, action["name"]).chomp_slash
    verb = action["verb"].upcase

    action.delete("verb")
    action.delete("name")
    action.delete("path")
    action.delete("scaffold")

    # for the purpose of the migration, the rel_path is everything after the .com
    rel_path = action_path.gsub("://", "").split("/")[1..-1].join('/')
    new_path = File.join(to_dir, "#{rel_path}-#{verb}.fdoc")
    
    `mkdir -p #{File.dirname(new_path)}`
    File.open(new_path, "w") { |f| f.write YAML.dump(action) }
  end
end

service_path = File.join(to_dir, "???.fdoc.service")
File.open(service_path, "w") { |f|
  f.write(YAML.dump({
    "name" => "???",
    "basePath" => base_path,
    "description" => "???"
  }))
}

# 1.0/strings-GET.fdoc attempt 1
## could be an alternative to
# 1.0/strings/GET.fdoc attempt 2

